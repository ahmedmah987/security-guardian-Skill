#!/bin/bash
# Security Guardian - Advanced AI Skill Security System
# Main command implementation

set -euo pipefail

SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
SECURITY_ROOT="/home/ahmed/.openclaw/workspace/security"
KEYS_DIR="$SECURITY_ROOT/keys"
CERTS_DIR="$SECURITY_ROOT/certs"
ENCRYPTED_DIR="$SECURITY_ROOT/encrypted"
LOGS_DIR="$SECURITY_ROOT/logs"
POLICIES_DIR="$SECURITY_ROOT/policies"

# Colors
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
PURPLE='\033[0;35m'
CYAN='\033[0;36m'
NC='\033[0m'

log_security_event() {
    local event_type="$1"
    local message="$2"
    local timestamp=$(date -u +"%Y-%m-%dT%H:%M:%SZ")
    
    mkdir -p "$LOGS_DIR"
    echo "$timestamp [$event_type] $message" >> "$LOGS_DIR/security.log"
    
    if [ "${SECURITY_DEBUG:-false}" = "true" ]; then
        echo -e "${CYAN}[DEBUG] $timestamp [$event_type] $message${NC}"
    fi
}

show_banner() {
    echo -e "${BLUE}"
    echo "‚ïî‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïó"
    echo "‚ïë                    SECURITY GUARDIAN üõ°Ô∏è                     ‚ïë"
    echo "‚ïë           Advanced AI Skill Security System                  ‚ïë"
    echo "‚ïö‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïù"
    echo -e "${NC}"
}

setup_security_infrastructure() {
    show_banner
    echo -e "${YELLOW}üîß Setting up security infrastructure...${NC}"
    
    # Create directory structure
    mkdir -p "$SECURITY_ROOT"/{keys,certs,encrypted,logs,policies,backup,crl}
    
    # Generate master CA if not exists
    if [ ! -f "$CERTS_DIR/ca.crt" ]; then
        echo -e "${BLUE}‚ö° Generating Certificate Authority...${NC}"
        
        # Create CA private key
        openssl genrsa -out "$KEYS_DIR/ca.key" 4096 2>/dev/null
        chmod 600 "$KEYS_DIR/ca.key"
        
        # Create CA certificate
        openssl req -x509 -new -nodes -key "$KEYS_DIR/ca.key" -sha256 -days 3650 \
            -out "$CERTS_DIR/ca.crt" -subj "/C=US/ST=Security/L=AI/O=SkillSecurity/CN=SkillSecurity-CA" 2>/dev/null
        
        log_security_event "CA_CREATE" "Certificate Authority created"
        echo -e "${GREEN}‚úÖ Certificate Authority created${NC}"
    fi
    
    # Generate intermediate certificate
    if [ ! -f "$CERTS_DIR/intermediate.crt" ]; then
        echo -e "${BLUE}‚ö° Generating intermediate certificate...${NC}"
        
        # Create intermediate key
        openssl genrsa -out "$KEYS_DIR/intermediate.key" 4096 2>/dev/null
        chmod 600 "$KEYS_DIR/intermediate.key"
        
        # Create CSR
        openssl req -new -key "$KEYS_DIR/intermediate.key" \
            -out "$CERTS_DIR/intermediate.csr" \
            -subj "/C=US/ST=Security/L=AI/O=SkillSecurity/CN=SkillSecurity-Intermediate" 2>/dev/null
        
        # Sign with CA
        openssl x509 -req -in "$CERTS_DIR/intermediate.csr" -CA "$CERTS_DIR/ca.crt" \
            -CAkey "$KEYS_DIR/ca.key" -CAcreateserial -out "$CERTS_DIR/intermediate.crt" \
            -days 1825 -sha256 -extensions v3_ca 2>/dev/null
        
        log_security_event "INTERMEDIATE_CREATE" "Intermediate certificate created"
        echo -e "${GREEN}‚úÖ Intermediate certificate created${NC}"
    fi
    
    # Create encryption key
    if [ ! -f "$KEYS_DIR/master.enc.key" ]; then
        echo -e "${BLUE}üîê Generating master encryption key...${NC}"
        openssl rand -base64 32 > "$KEYS_DIR/master.enc.key"
        chmod 600 "$KEYS_DIR/master.enc.key"
        
        log_security_event "KEY_GENERATE" "Master encryption key created"
        echo -e "${GREEN}‚úÖ Master encryption key created${NC}"
    fi
    
    # Create security policy
    if [ ! -f "$POLICIES_DIR/default.json" ]; then
        echo -e "${BLUE}üìã Creating default security policy...${NC}"
        cat > "$POLICIES_DIR/default.json" << EOF
{
  "policy_name": "default",
  "security_level": "enhanced",
  "encryption": {
    "algorithm": "aes-256-cbc",
    "key_rotation_days": 90
  },
  "signing": {
    "algorithm": "rsa-sha256",
    "certificate_validity_days": 365
  },
  "verification": {
    "check_revocation": true,
    "verify_chain": true,
    "require_encryption": true
  },
  "compliance": {
    "log_all_events": true,
    "audit_frequency_days": 30,
    "backup_required": true
  }
}
EOF
        echo -e "${GREEN}‚úÖ Default security policy created${NC}"
    fi
    
    echo -e "${GREEN}üéâ Security infrastructure ready!${NC}"
}

secure_skill_file() {
    local skill_file="$1"
    
    if [ ! -f "$skill_file" ]; then
        echo -e "${RED}‚ùå File not found: $skill_file${NC}"
        return 1
    fi
    
    local skill_name=$(basename "$(dirname "$skill_file")")
    local timestamp=$(date +%Y%m%d_%H%M%S)
    local secure_name="${skill_name}_${timestamp}"
    
    echo -e "${BLUE}üîí Securing skill: $skill_name${NC}"
    
    # Generate skill-specific key pair
    local skill_key="$KEYS_DIR/${skill_name}.key"
    local skill_cert="$CERTS_DIR/${skill_name}.crt"
    
    if [ ! -f "$skill_key" ]; then
        echo -e "${YELLOW}‚ö° Generating skill certificates...${NC}"
        
        # Generate skill private key
        openssl genrsa -out "$skill_key" 2048 2>/dev/null
        chmod 600 "$skill_key"
        
        # Create CSR
        openssl req -new -key "$skill_key" \
            -out "$CERTS_DIR/${skill_name}.csr" \
            -subj "/C=US/ST=Security/L=AI/O=SkillSecurity/CN=${skill_name}" 2>/dev/null
        
        # Sign with intermediate CA
        openssl x509 -req -in "$CERTS_DIR/${skill_name}.csr" \
            -CA "$CERTS_DIR/intermediate.crt" -CAkey "$KEYS_DIR/intermediate.key" \
            -CAcreateserial -out "$skill_cert" -days 365 -sha256 2>/dev/null
        
        log_security_event "CERT_CREATE" "Certificate created for $skill_name"
    fi
    
    # Encrypt the skill file
    local encrypted_file="$ENCRYPTED_DIR/${secure_name}.enc"
    echo -e "${YELLOW}üîê Encrypting skill file...${NC}"
    openssl enc -aes-256-cbc -salt -in "$skill_file" -out "$encrypted_file" \
        -pass file:"$KEYS_DIR/master.enc.key" 2>/dev/null
    
    # Create digital signature
    local signature_file="$ENCRYPTED_DIR/${secure_name}.sig"
    echo -e "${YELLOW}‚úçÔ∏è  Creating digital signature...${NC}"
    openssl dgst -sha256 -sign "$skill_key" -out "$signature_file" "$encrypted_file" 2>/dev/null
    
    # Create integrity hash
    local hash_file="$ENCRYPTED_DIR/${secure_name}.hash"
    sha256sum "$encrypted_file" "$signature_file" > "$hash_file"
    
    # Create security manifest
    local manifest_file="$ENCRYPTED_DIR/${secure_name}.manifest.json"
    cat > "$manifest_file" << EOF
{
  "skill_name": "$skill_name",
  "timestamp": "$(date -u +%Y-%m-%dT%H:%M:%SZ)",
  "security_version": "1.0",
  "encryption": {
    "algorithm": "AES-256-CBC",
    "encrypted_file": "$(basename "$encrypted_file")",
    "key_derivation": "PBKDF2-SHA256"
  },
  "signature": {
    "algorithm": "RSA-SHA256",
    "signature_file": "$(basename "$signature_file")",
    "certificate": "$(basename "$skill_cert")",
    "certificate_chain": ["intermediate.crt", "ca.crt"]
  },
  "integrity": {
    "hash_file": "$(basename "$hash_file")",
    "algorithm": "SHA256"
  },
  "policy": {
    "name": "default",
    "security_level": "enhanced"
  }
}
EOF
    
    log_security_event "SECURE" "Skill $skill_name secured with enhanced protection"
    
    echo -e "${GREEN}‚úÖ Skill secured successfully!${NC}"
    echo -e "${CYAN}   Encrypted: $(basename "$encrypted_file")${NC}"
    echo -e "${CYAN}   Signature: $(basename "$signature_file")${NC}"
    echo -e "${CYAN}   Manifest: $(basename "$manifest_file")${NC}"
    echo -e "${YELLOW}   üîë Save this timestamp: $timestamp${NC}"
}

verify_skill_integrity() {
    local skill_name="$1"
    local timestamp="$2"
    
    local secure_name="${skill_name}_${timestamp}"
    local encrypted_file="$ENCRYPTED_DIR/${secure_name}.enc"
    local signature_file="$ENCRYPTED_DIR/${secure_name}.sig"
    local manifest_file="$ENCRYPTED_DIR/${secure_name}.manifest.json"
    local skill_cert="$CERTS_DIR/${skill_name}.crt"
    local skill_key="$KEYS_DIR/${skill_name}.key"
    
    echo -e "${BLUE}üîç Verifying skill: $skill_name${NC}"
    
    # Check if files exist
    for file in "$encrypted_file" "$signature_file" "$manifest_file"; do
        if [ ! -f "$file" ]; then
            echo -e "${RED}‚ùå File not found: $(basename "$file")${NC}"
            return 1
        fi
    done
    
    # Verify certificate chain
    echo -e "${YELLOW}üîç Verifying certificate chain...${NC}"
    if ! openssl verify -CAfile <(cat "$CERTS_DIR/ca.crt" "$CERTS_DIR/intermediate.crt") "$skill_cert" >/dev/null 2>&1; then
        echo -e "${RED}‚ùå Certificate chain verification failed${NC}"
        return 1
    fi
    
    # Verify digital signature
    echo -e "${YELLOW}üîç Verifying digital signature...${NC}"
    if ! openssl dgst -sha256 -verify <(openssl x509 -in "$skill_cert" -pubkey -noout) \
            -signature "$signature_file" "$encrypted_file" 2>/dev/null; then
        echo -e "${RED}‚ùå Digital signature verification failed${NC}"
        return 1
    fi
    
    # Verify file integrity
    echo -e "${YELLOW}üîç Verifying file integrity...${NC}"
    local hash_file="$ENCRYPTED_DIR/${secure_name}.hash"
    if [ -f "$hash_file" ]; then
        if ! sha256sum -c "$hash_file" >/dev/null 2>&1; then
            echo -e "${RED}‚ùå Integrity hash verification failed${NC}"
            return 1
        fi
    fi
    
    log_security_event "VERIFY" "Skill $skill_name verified successfully"
    echo -e "${GREEN}‚úÖ Skill verification successful!${NC}"
    return 0
}

audit_all_skills() {
    echo -e "${BLUE}üîç Starting comprehensive security audit...${NC}"
    
    local total_skills=0
    local secure_skills=0
    local vulnerable_skills=0
    
    # Check encrypted skills
    echo -e "${YELLOW}üìã Auditing encrypted skills...${NC}"
    for manifest in "$ENCRYPTED_DIR"/*.manifest.json; do
        if [ -f "$manifest" ]; then
            ((total_skills++))
            local skill_name=$(jq -r '.skill_name' "$manifest" 2>/dev/null || echo "unknown")
            local timestamp=$(echo "$manifest" | grep -o '[0-9]\{8\}_[0-9]\{6\}' || echo "unknown")
            
            echo -e "${CYAN}   Checking: $skill_name${NC}"
            
            if verify_skill_integrity "$skill_name" "$timestamp" >/dev/null 2>&1; then
                ((secure_skills++))
                echo -e "${GREEN}   ‚úÖ SECURE: $skill_name${NC}"
            else
                ((vulnerable_skills++))
                echo -e "${RED}   ‚ùå VULNERABLE: $skill_name${NC}"
            fi
        fi
    done
    
    # Check for unsigned skills
    echo -e "${YELLOW}üìã Checking for unsigned skills...${NC}"
    while IFS= read -r -d '' skill_file; do
        local skill_name=$(basename "$(dirname "$skill_file")")
        local is_signed=false
        
        for manifest in "$ENCRYPTED_DIR"/*.manifest.json; do
            if [ -f "$manifest" ] && jq -e ".skill_name == \"$skill_name\"" "$manifest" >/dev/null 2>&1; then
                is_signed=true
                break
            fi
        done
        
        if [ "$is_signed" = false ]; then
            ((total_skills++))
            ((vulnerable_skills++))
            echo -e "${RED}   ‚ùå UNSIGNED: $skill_name${NC}"
        fi
    done < <(find "/home/ahmed/.openclaw/workspace/skills" -name "SKILL.md" -type f -print0)
    
    # Generate audit report
    local audit_report="$SECURITY_ROOT/audit_$(date +%Y%m%d_%H%M%S).json"
    cat > "$audit_report" << EOF
{
  "audit_timestamp": "$(date -u +%Y-%m-%dT%H:%M:%SZ)",
  "summary": {
    "total_skills": $total_skills,
    "secure_skills": $secure_skills,
    "vulnerable_skills": $vulnerable_skills,
    "security_percentage": $(( secure_skills * 100 / total_skills ))
  },
  "recommendations": [
    "Implement regular security audits",
    "Sign all unsigned skills",
    "Monitor for security updates",
    "Backup security keys regularly"
  ]
}
EOF
    
    echo -e "${BLUE}"
    echo "‚ïî‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïó"
    echo "‚ïë                    AUDIT COMPLETE üìä                        ‚ïë"
    echo "‚ïö‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïù"
    echo -e "${NC}"
    echo -e "${CYAN}Total Skills: $total_skills${NC}"
    echo -e "${GREEN}Secure Skills: $secure_skills${NC}"
    echo -e "${RED}Vulnerable Skills: $vulnerable_skills${NC}"
    echo -e "${YELLOW}Security Score: $(( secure_skills * 100 / total_skills ))%${NC}"
    echo -e "${CYAN}Report: $audit_report${NC}"
    
    log_security_event "AUDIT" "Completed audit: $secure_skills/$total_skills skills secure"
}

# Main command dispatcher
case "${1:-help}" in
    setup)
        setup_security_infrastructure
        ;;
    secure)
        if [ -z "${2:-}" ]; then
            echo "Usage: $0 secure <skill-file>"
            exit 1
        fi
        secure_skill_file "$2"
        ;;
    verify)
        if [ -z "${2:-}" ] || [ -z "${3:-}" ]; then
            echo "Usage: $0 verify <skill-name> <timestamp>"
            exit 1
        fi
        verify_skill_integrity "$2" "$3"
        ;;
    audit)
        audit_all_skills
        ;;
    help|--help|-h)
        show_banner
        echo "Usage: $0 {setup|secure|verify|audit|help}"
        echo ""
        echo "Commands:"
        echo "  setup           - Initialize security infrastructure"
        echo "  secure <file>   - Encrypt and sign a skill file"
        echo "  verify <name> <timestamp> - Verify skill integrity"
        echo "  audit           - Comprehensive security audit"
        echo "  help            - Show this help message"
        ;;
    *)
        echo -e "${RED}‚ùå Unknown command: $1${NC}"
        echo "Use '$0 help' for usage information"
        exit 1
        ;;
esac